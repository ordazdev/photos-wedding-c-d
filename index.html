<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Firebase Image Upload</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f5f5f5;
        background-image: url("images/bg-image-newport.png"); /* Default desktop background */
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        background-attachment: fixed;
        min-height: 100vh;
      }

      .container {
        width: 95%;
        max-width: 800px;
        margin: 20px auto;
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: #333;
        text-align: center;
        font-size: 1.8rem;
        margin-bottom: 20px;
      }

      .upload-area {
        border: 2px dashed #ccc;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        margin: 20px 0;
        transition: all 0.3s;
        cursor: pointer;
      }

      .upload-area:hover,
      .upload-area:active {
        border-color: #4285f4;
      }

      .upload-area.highlight {
        border-color: #4285f4;
        background-color: #f0f7ff;
      }

      .file-input {
        display: none;
      }

      .btn {
        background-color: #4285f4;
        color: white;
        padding: 12px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s;
        touch-action: manipulation;
      }

      .btn:hover,
      .btn:active {
        background-color: #3367d6;
      }

      .progress-bar {
        width: 100%;
        height: 12px;
        background-color: #f1f1f1;
        border-radius: 6px;
        margin: 15px 0;
        overflow: hidden;
        display: none;
      }

      .progress {
        height: 100%;
        background-color: #4285f4;
        width: 0%;
        transition: width 0.3s;
      }

      .gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
        gap: 10px;
        margin-top: 20px;
      }

      .image-container {
        position: relative;
        border-radius: 4px;
        overflow: hidden;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        aspect-ratio: 1;
      }

      .image-container img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
      }

      .image-container .delete-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background-color: rgba(255, 255, 255, 0.8);
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 20px;
        transition: opacity 0.3s;
      }

      /* Always show delete button on mobile for better touch experience */
      .image-container .delete-btn {
        opacity: 1;
      }

      .status {
        margin-top: 15px;
        text-align: center;
        color: #555;
        min-height: 24px;
      }

      /* Link buttons styles */
      .link-buttons {
        display: flex;
        flex-direction: row;
        justify-content: center;
        gap: 15px;
        margin-top: 30px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }

      .link-btn {
        background-color: #4285f4;
        color: white;
        padding: 12px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        text-decoration: none;
        display: inline-block;
        transition: background-color 0.3s;
        text-align: center;
        flex: 1 0 130px;
        max-width: 200px;
      }

      .link-btn:hover,
      .link-btn:active {
        background-color: #3367d6;
      }

      /* Media Queries */
      @media (max-width: 768px) {
        body {
          background-image: url("images/mobile-398x754-bg.png");
        }

        h1 {
          font-size: 1.5rem;
        }

        .container {
          width: 100%;
          margin: 0;
          border-radius: 0;
          padding: 15px;
          min-height: 100vh;
        }

        .upload-area {
          padding: 15px;
        }

        .gallery {
          grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
          gap: 8px;
        }
      }

      @media (max-width: 480px) {
        .btn {
          width: 100%;
          padding: 15px;
          font-size: 16px;
        }

        .link-buttons {
          flex-direction: column;
          align-items: center;
        }

        .link-btn {
          width: 100%;
          max-width: none;
          flex: none;
          margin-bottom: 10px;
        }
      }

      /* Ensure tap targets are large enough on mobile */
      @media (hover: none) {
        .btn,
        .link-btn,
        .delete-btn {
          min-height: 44px;
          min-width: 44px;
        }
      }

      /* Add safe area insets for notched phones */
      @supports (padding: max(0px)) {
        .container {
          padding-left: max(20px, env(safe-area-inset-left));
          padding-right: max(20px, env(safe-area-inset-right));
          padding-bottom: max(20px, env(safe-area-inset-bottom));
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Upload Photos Here</h1>

      <div class="upload-area" id="uploadArea">
        <p>Share with Us</p>
        <input
          type="file"
          id="fileInput"
          class="file-input"
          accept="image/*"
          multiple
          capture="environment"
        />
        <button class="btn">Select Photos</button>
      </div>

      <div class="progress-bar" id="progressBar">
        <div class="progress" id="progress"></div>
      </div>

      <div class="status" id="status"></div>

      <div class="gallery" id="gallery"></div>

      <div class="link-buttons">
        <a
          href="https://www.zola.com/wedding/mchaleordazwedding/wedding_party"
          class="link-btn"
          >Wedding Info</a
        >
        <a
          href="https://www.honeyfund.com/site/McHaleOrdazWedding"
          class="link-btn"
          >Honey Fund</a
        >
      </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
      // Your Firebase configuration
      const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_AUTH_DOMAIN",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_STORAGE_BUCKET",
        messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
        appId: "YOUR_APP_ID",
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);

      // Reference to storage and firestore
      const storage = firebase.storage();
      const db = firebase.firestore();
      const imagesCollection = db.collection("images");

      // DOM elements
      const uploadArea = document.getElementById("uploadArea");
      const fileInput = document.getElementById("fileInput");
      const progressBar = document.getElementById("progressBar");
      const progress = document.getElementById("progress");
      const gallery = document.getElementById("gallery");
      const status = document.getElementById("status");

      // Event listeners with better mobile support
      uploadArea.addEventListener("click", () => fileInput.click());
      fileInput.addEventListener("change", handleFileSelect);

      // Improved drag and drop handling
      uploadArea.addEventListener("dragover", (e) => {
        e.preventDefault();
        e.stopPropagation();
        uploadArea.classList.add("highlight");
      });

      uploadArea.addEventListener("dragleave", (e) => {
        e.preventDefault();
        e.stopPropagation();
        uploadArea.classList.remove("highlight");
      });

      uploadArea.addEventListener("drop", (e) => {
        e.preventDefault();
        e.stopPropagation();
        uploadArea.classList.remove("highlight");

        if (e.dataTransfer.files.length) {
          handleFiles(e.dataTransfer.files);
        }
      });

      // Touch events for mobile
      uploadArea.addEventListener(
        "touchstart",
        (e) => {
          uploadArea.classList.add("highlight");
        },
        { passive: true }
      );

      uploadArea.addEventListener(
        "touchend",
        (e) => {
          uploadArea.classList.remove("highlight");
        },
        { passive: true }
      );

      // Load existing images on page load
      document.addEventListener("DOMContentLoaded", () => {
        loadImages();
      });

      // Handle file selection
      function handleFileSelect(e) {
        const files = e.target.files;
        if (files.length) {
          handleFiles(files);
        }
      }

      // Process selected files
      function handleFiles(files) {
        let validFiles = 0;
        for (const file of files) {
          if (!file.type.match("image.*")) {
            continue;
          }
          validFiles++;
          uploadImage(file);
        }

        if (validFiles === 0) {
          status.textContent = "Please select valid image files";
        } else {
          status.textContent = `Uploading ${validFiles} image${
            validFiles > 1 ? "s" : ""
          }...`;
        }
      }

      // Upload image to Firebase with file compression if possible
      function uploadImage(file) {
        // Show progress bar
        progressBar.style.display = "block";
        progress.style.width = "0%";

        // Create a unique filename
        const timestamp = new Date().getTime();
        const fileName = `${timestamp}_${file.name.replace(
          /[^a-zA-Z0-9_.]/g,
          "_"
        )}`;

        // Try to compress image before upload for mobile
        if (
          window.FileReader &&
          window.Blob &&
          "createObjectURL" in URL &&
          file.size > 1000000
        ) {
          compressAndUpload(file, fileName);
        } else {
          // Direct upload if compression not possible
          uploadToFirebase(file, fileName);
        }
      }

      // Compress image using canvas if possible
      function compressAndUpload(file, fileName) {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
          const img = new Image();
          img.src = e.target.result;
          img.onload = () => {
            const canvas = document.createElement("canvas");
            let width = img.width;
            let height = img.height;

            // Resize large images
            const MAX_WIDTH = 1200;
            const MAX_HEIGHT = 1200;

            if (width > height) {
              if (width > MAX_WIDTH) {
                height *= MAX_WIDTH / width;
                width = MAX_WIDTH;
              }
            } else {
              if (height > MAX_HEIGHT) {
                width *= MAX_HEIGHT / height;
                height = MAX_HEIGHT;
              }
            }

            canvas.width = width;
            canvas.height = height;

            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, width, height);

            // Get compressed image
            canvas.toBlob(
              (blob) => {
                if (blob) {
                  // Check if compression actually helped
                  if (blob.size < file.size) {
                    uploadToFirebase(
                      new File([blob], file.name, { type: file.type }),
                      fileName
                    );
                  } else {
                    uploadToFirebase(file, fileName);
                  }
                } else {
                  uploadToFirebase(file, fileName);
                }
              },
              file.type,
              0.7
            ); // Compression quality
          };
        };
      }

      // Upload to Firebase Storage
      function uploadToFirebase(file, fileName) {
        // Create storage reference
        const storageRef = storage.ref(`images/${fileName}`);

        // Start upload
        const uploadTask = storageRef.put(file);

        // Monitor upload progress
        uploadTask.on(
          "state_changed",
          // Progress
          (snapshot) => {
            const percentage =
              (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            progress.style.width = percentage + "%";
          },
          // Error
          (error) => {
            status.textContent = "Upload failed: " + error.message;
            progressBar.style.display = "none";
          },
          // Complete
          async () => {
            // Get download URL
            try {
              const downloadURL = await storageRef.getDownloadURL();

              // Save to Firestore
              await saveImageData({
                name: file.name,
                url: downloadURL,
                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                size: file.size,
                type: file.type,
              });

              // Reset UI
              status.textContent = "Upload complete!";
              setTimeout(() => {
                status.textContent = "";
              }, 3000);

              progressBar.style.display = "none";
              progress.style.width = "0%";

              // Clear file input
              fileInput.value = "";
            } catch (error) {
              console.error("Error finalizing upload:", error);
              status.textContent = "Upload failed at final step.";
              progressBar.style.display = "none";
            }
          }
        );
      }

      // Save image metadata to Firestore
      async function saveImageData(imageData) {
        try {
          const docRef = await imagesCollection.add(imageData);
          addImageToGallery({
            id: docRef.id,
            ...imageData,
          });
          return true;
        } catch (error) {
          console.error("Error saving image data:", error);
          return false;
        }
      }

      // Load images from Firestore
      async function loadImages() {
        try {
          gallery.innerHTML =
            "<div class='loading-indicator'>Loading images...</div>";

          const snapshot = await imagesCollection
            .orderBy("timestamp", "desc")
            .limit(20) // Limit for better mobile performance
            .get();

          gallery.innerHTML = "";

          if (snapshot.empty) {
            gallery.innerHTML =
              "<p style='grid-column: 1/-1; text-align: center; color: #777;'>No images yet. Be the first to upload!</p>";
            return;
          }

          snapshot.forEach((doc) => {
            const imageData = {
              id: doc.id,
              ...doc.data(),
            };
            addImageToGallery(imageData);
          });
        } catch (error) {
          console.error("Error loading images:", error);
          status.textContent = "Failed to load images.";
          gallery.innerHTML =
            "<p style='grid-column: 1/-1; text-align: center; color: #777;'>Error loading images.</p>";
        }
      }

      // Add image to gallery with lazy loading
      function addImageToGallery(imageData) {
        const imageContainer = document.createElement("div");
        imageContainer.className = "image-container";
        imageContainer.dataset.id = imageData.id;

        const img = document.createElement("img");
        img.loading = "lazy"; // Lazy loading for better performance
        img.src = imageData.url;
        img.alt = imageData.name || "Uploaded image";

        // Placeholder until image loads
        img.style.backgroundColor = "#f0f0f0";

        // Add loading indicator
        img.onload = () => {
          img.style.backgroundColor = "transparent";
        };

        const deleteBtn = document.createElement("button");
        deleteBtn.className = "delete-btn";
        deleteBtn.innerHTML = "Ã—";
        deleteBtn.setAttribute("aria-label", "Delete image");

        // Increase touch target size for mobile
        deleteBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          if (confirm("Delete this image?")) {
            deleteImage(imageData.id, imageData.url);
          }
        });

        imageContainer.appendChild(img);
        imageContainer.appendChild(deleteBtn);
        gallery.appendChild(imageContainer);

        // Make image tappable to view larger
        img.addEventListener("click", () => {
          window.open(imageData.url, "_blank");
        });
      }

      // Delete image from Firebase
      async function deleteImage(id, url) {
        try {
          status.textContent = "Deleting image...";

          // Delete from Firestore
          await imagesCollection.doc(id).delete();

          // Delete from Storage
          const storageRef = storage.refFromURL(url);
          await storageRef.delete();

          // Remove from gallery
          const imageContainer = gallery.querySelector(`[data-id="${id}"]`);
          if (imageContainer) {
            imageContainer.style.opacity = "0.5";
            setTimeout(() => {
              gallery.removeChild(imageContainer);
            }, 300);
          }

          status.textContent = "Image deleted successfully.";
          setTimeout(() => {
            status.textContent = "";
          }, 3000);
        } catch (error) {
          console.error("Error deleting image:", error);
          status.textContent = "Failed to delete image.";
        }
      }

      // Handle network connectivity issues
      window.addEventListener("online", () => {
        status.textContent = "You're back online! Refreshing...";
        setTimeout(() => {
          loadImages();
          status.textContent = "";
        }, 1000);
      });

      window.addEventListener("offline", () => {
        status.textContent =
          "You're offline. Some features may be unavailable.";
      });
    </script>
  </body>
</html>
